---
title: "Survival analysis in an experimental microbial aquatic community"
output: 
  bookdown::html_document2
date: "`r format(Sys.time(), '%d %B %Y')`"
indent: true
bibliography: references.bib
---

<!-- ## Why study extinction of species? -->

A single species extinction can cause a chain of secondary extinctions leading to a trophic cascade in a food web [@dunneCascadingExtinctionsCommunity2009]. Hence, it is important to improve our predictive understanding of the causes and consequences of biodiversity loss in an ecosystem. Knowing the reason behind species extinction can help us improve conservation efforts. 

<!-- ## Why do we need to know when species will extinct? -->

The order in which species extinct in a food web influences the consequences of the extinction event. For example, loss of larger species first, followed by smaller species, can cause a more rapid loss of ecosystem functioning in marine sediments than a random extinction order, according to simulation-based predictions [@solanExtinctionEcosystemFunction2004]. Therefore, other than knowing which species might suffer extinction, it is also crucial to know when the species will go extinct.

<!-- ## What factors influence species extinction? -->

Species in a community are linked by a complex network of interactions such as competition, predation and mutualisms. This can result in the extinction of one species caused by the loss of other species [@paineFoodWebComplexity1966]. Species extinction can also be influenced by abiotic environmental factors [@cardilloMultipleCausesHigh2005].

<!-- ## What we propose to do in our study? -->

In this project, we would like to study the effect of environmental factors and interspecific interactions on the extinction rates of species in an experimental microbial aquatic community. In the experiment, four different treatment combinations had been used, varying temperature and nutrient concentration in the microcosms. We would like to investigate the combined effect of interspecific interactions and environmental factors on the determinants of extinction events.

<!-- ## What are the possible research questions of the project? -->

We will use survival analysis with a Bayesian approach to estimate the mean extinction times of the species. Possible research questions of this project are:

* Using informative priors derived from empirical studies 

* Using a different survival model than the current one in the preliminary study below


# Aquatic food web 

The aquatic food web consists of a 17 taxa of aquatic eukaryotic microorganisms, unknown heterotrophic nanoflagellates and an unknown bacterial flora (Fig. \@ref(fig:fig1)). The species in the food web (Fig. \@ref(fig:fig1)) are: 3 *Blepharisma japonicum*, 4 *Chilomonas paramecium*, 5 *Colpidium striatum*, 6 *Colpoda cucculus*, 7 *Cyclidium glaucoma*, 8 *Didinium nasutum*, 9 *Dileptus anser*, 10 *Entosiphon*, 11 *Euplotes patella*, 12 *Loxocephallus*, 13 *Lepadella*, 14 *Dicanophoridae*, 15 *Paramecium bursaria*, 16 *Paramecium caudatum*, 17 *Telotrochiudium*, 18 *Tetrahymena piriformis* and 19 *Vorticella*.

```{r fig1, echo=FALSE, fig.cap= "Food web: species are grouped according to their trophic group. The size of each node is proportional to the logarithm of the body size of the species and color indicates the mean extinction time of the species computed by maximizing likelihood across all treatments, with a darker shade of red corresponding to lower extinction times [@palamaraTheoreticalEmpiricalStudies2015]." }

knitr::include_graphics(path = "foodweb_main.png")
```


# Dataset

The experiment for the current dataset was conducted by Nicholas Worsfold at the University of Sheffield [@worsfoldConsequencesExtinctionExperimental2007].
The data is from a highly replicated microcosm experiment where the extinction times of freshwater protists species forming a small food web was recorded. Four different treatment combinations have been used, varying temperature and nutrient concentration in the microcosms. 

Data from the experiment is the presence or absence of each species for each of the eight weeks of the experiment, for each of the 200 replicates.

# Preliminary study using a subset of the dataset

Below, we subset the dataset for the treatment with low temperature and low nutrient concentration for the species *chilomonas*. We fit the survival model with both the Bayesian approach and maximum likelihood approach to compute the mean extinction times and compare them.

```{r message = FALSE, warning = FALSE}

## Loading the packages
if ( ! require(runjags) )   { install.packages("runjags");   library(runjags) }
if ( ! require(rjags) )   { install.packages("rjags");   library(rjags) }
if ( ! require(bbmle) )   { install.packages("bbmle");   library(bbmle) }
if ( ! require(ggpubr) )   { install.packages("ggpubr");   library(ggpubr) }

## Importing the dataset
## Change the path accordingly
dd <- readRDS("main_data.Rdata")

## Some summary of the dataset
all.species <- sort(unique(dd$species))
all.temp <- sort(unique(dd$temp))
all.energy <- sort(unique(dd$energy))

## Subsetting the dataset: Low temperature; low energy and species "chilomonas"
ddll <- subset(dd, dd$temp.var==0)
ddll <- subset(ddll, ddll$energy.var==0)
ss <- 2 #corresponds to species chilomonas
spp.dd <- subset(ddll, ddll$species==all.species[ss])

## Let's look at the subsetted dataset spp.dd
head(spp.dd)

## day2 is the week in which the species was first not observed i.e. the species extinct by that week
day2 <- spp.dd$day2

```

## Bayesian method

```{r message=FALSE, warning=FALSE}
##################################### Using the Bayesian method #####################################

## Define the model in JAGS:
## Considering uniform priors for the parameters

file.jags.model <- "main.jags"

cat("model {\n",
    "  shape ~ dunif(0, max_shape)\n",
    "  lambda ~ dunif(0, max_lambda)\n",
    "  for ( i in 1:n ) {\n",
    "    day2[i] ~ dweib(shape, lambda)\n",
    "  }\n",
    "}\n",
    sep="",
    file=file.jags.model)


## Run JAGS:
max_shape <- 100
max_lambda <- 100
jags.obj <- jags.model(file.jags.model,
                       data=list(max_shape = max_shape,
                                 max_lambda = max_lambda,
                                 n         = 50,
                                 day2      = day2))

sampsize <- 10000
jags.res <- coda.samples(jags.obj, c("shape", "lambda"), sampsize)
plot(jags.res)

## Constructing a data frame with the samples from the posterior distributions
chains <- as.matrix(jags.res)
post_par <- data.frame(lambda = chains[,1],
                       shape = chains[,2], Distribution = "Posterior")
post_par <- rbind(post_par,
                  data.frame(lambda = runif(n = 10000, 0, max_lambda),
                             shape = runif(n = 10000, 0, max_shape), Distribution = "Prior"))


```

## Maximum Likelihood method

```{r message=FALSE, warning=FALSE}
##################################### Using the Maximum Likelihood method #####################################

# Defining the weibull negative log likelihood here

Weibull.2x2.LF_mod <- function(lscale.0, lscale.t, lscale.e, lscale.i,
                           lshape.0, lshape.t, lshape.e, lshape.i,
                           day1, day2, temp.var, energy.var, spp.id) {
    scale <- exp(lscale.0 +
                     lscale.t*temp.var +
                     lscale.e*energy.var +
                     lscale.i*temp.var*energy.var)
    shape <- exp(lshape.0 +
                     lshape.t*temp.var +
                     lshape.e*energy.var +
                     lshape.i*temp.var*energy.var)
    -sum(log(dweibull(day2, shape, scale)))
}


totmeansurv <- mean(spp.dd$week.persist+0.5)
startvals.SE <- list(lscale.0=log(totmeansurv), lscale.t=0, lscale.e=0, lscale.i=0,
                     lshape.0=0, lshape.t=0, lshape.e=0, lshape.i=0)

## Running the Maximum Likelihood method
m0 <- mle2(Weibull.2x2.LF_mod, start=startvals.SE, data=spp.dd,
           fixed=list(lscale.t=0,lscale.e=0,lscale.i=0,lshape.t=0,lshape.e=0,lshape.i=0))
lscale0.0<-coef(m0)[1];lscale0.t<-coef(m0)[2];lscale0.e<-coef(m0)[3];lscale0.i<-coef(m0)[4]
lshape0.0<-coef(m0)[5];lshape0.t<-coef(m0)[6];lshape0.e<-coef(m0)[7];lshape0.i<-coef(m0)[8]

scale <- exp(lscale0.0 + lscale0.t + lscale0.e + lscale0.i)
shape <- exp(lshape0.0 + lshape0.t + lshape0.e + lshape0.i)
lambda <- (1/scale)^shape

print(paste0("Estimated shape = ", shape))
print(paste0("Estimated lambda = ", lambda))
```


## Comparing Bayesian and Maximum likelihood method
```{r message=FALSE, warning=FALSE}
## Plotting the distribution of the parameters along with the point estimates from the MLE method

x_dummy <- data.frame(x = -10, y = 1, Method = "MLE method")
cols <- c("MLE method" = "black")

plot_lambda <- ggplot(post_par) +
    geom_density(aes(x = lambda, y = ..density.., fill = Distribution), alpha = 0.5) +
    theme_classic() +
    xlim(c(0,3)) +
    geom_vline(xintercept = lambda) +
    xlab("Lambda") +
    ylab("Density") +
    geom_vline(data = x_dummy, aes(xintercept = x, color = Method)) +
    scale_color_manual(values = cols)

plot_shape <- ggplot(post_par) +
    geom_density(aes(x = shape, y = ..density.., fill = Distribution), alpha = 0.5) +
    theme_classic() +
    xlim(c(1,8)) +
    geom_vline(xintercept = shape) +
    xlab("Shape") +
    ylab("Density") +
    geom_vline(data = x_dummy, aes(xintercept = x, color = Method)) +
    scale_color_manual(values = cols)

ggarrange(plot_lambda, plot_shape, nrow = 2, ncol = 1, common.legend = TRUE, legend = "bottom")
```


# References